name: Auto Update Worker

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥ï¼‰'
        type: boolean
        required: true
        default: false

permissions:
  contents: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      new_version: ${{ steps.update.outputs.new_version }}
    steps:
      # ... [ä¿æŒåŸæœ‰æ­¥éª¤ä¸å˜] ...

      - name: æäº¤æ›´æ”¹
        if: ${{ steps.update.outputs.new_version != '' }}
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          repository: worker-repo
          commit_message: "ğŸ”„ è‡ªåŠ¨åŒæ­¥ Worker ç‰ˆæœ¬: ${{ steps.update.outputs.new_version }}"
          branch: ${{ github.head_ref || github.ref_name }}
          file_pattern: "version.txt dist/**"
          commit_options: '--signoff'
          push_options: '--force-if-includes'

      # é‚®ä»¶é€šçŸ¥é…ç½®ï¼ˆå…³é”®é…ç½®ç‚¹ï¼‰
      - name: å‘é€æ›´æ–°æˆåŠŸé‚®ä»¶
        if: ${{ success() && steps.update.outputs.new_version != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com  # QQé‚®ç®±SMTPæœåŠ¡å™¨
          server_port: 465            # SSLåŠ å¯†ç«¯å£
          username: ${{ secrets.SMTP_USERNAME }}  # éœ€é…ç½®ä¸º762600467@qq.com
          password: ${{ secrets.SMTP_PASSWORD }}  # éœ€é…ç½®ä¸ºæˆæƒç gmndgkaexfiqbfgb
          subject: "ğŸ‰ Worker æ›´æ–°æˆåŠŸ - ${{ steps.update.outputs.new_version }}"
          body: |
            æ‚¨çš„ Worker å·²æˆåŠŸæ›´æ–°è‡³ç‰ˆæœ¬ï¼š${{ steps.update.outputs.new_version }}
            
            æ›´æ–°è¯¦æƒ…ï¼š
            - è§¦å‘æ–¹å¼ï¼š${{ github.event_name }}
            - ä»“åº“ï¼š${{ github.repository }}
            - æäº¤å“ˆå¸Œï¼š${{ github.sha }}
            - æ›´æ–°æ—¶é—´ï¼š${{ github.event.workflow_run.created_at }}
          to: ${{ secrets.EMAIL_RECIPIENT }}  # æ¥æ”¶é‚®ç®±ï¼ˆå»ºè®®é…ç½®ä¸º762600467@qq.comï¼‰
          from: ${{ secrets.EMAIL_SENDER }}    # å‘ä»¶é‚®ç®±ï¼ˆå»ºè®®é…ç½®ä¸º762600467@qq.comï¼‰
          secure: true
          convert_markdown: true
          # å¯é€‰å¢å¼ºé…ç½®
          attachments: ""  # å¦‚éœ€æ·»åŠ é™„ä»¶å¯é…ç½®è·¯å¾„
          priority: high   # è®¾ç½®é‚®ä»¶ä¼˜å…ˆçº§
