name: Sync OpenCorePkg

on:
  schedule:
    - cron: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  id-token: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ğŸ”„ æ£€å‡ºOpenCorePkgä»“åº“
        uses: actions/checkout@v4
        with:
          repository: acidanthera/OpenCorePkg
          path: opencore-repo
          fetch-depth: 0
          ref: master  # OpenCorePkgå®é™…ä½¿ç”¨masteråˆ†æ”¯
          lfs: true    # ç¡®ä¿æ‹‰å–Git LFSæ–‡ä»¶

      - name: ğŸ” éªŒè¯ä»“åº“å†…å®¹
        run: |
          echo "å½“å‰ç›®å½•ç»“æ„ï¼š"
          ls -la opencore-repo/.git  # éªŒè¯.gitç›®å½•å­˜åœ¨
          git --git-dir=opencore-repo/.git status

      - name: ğŸ”„ åˆå§‹åŒ–å­æ¨¡å—
        working-directory: opencore-repo
        run: |
          git submodule update --init --recursive
          git submodule foreach 'git checkout $(git config -f $toplevel/.gitmodules submodule.$name.branch || echo master)'

      - name: ğŸ“ å‡†å¤‡åŒæ­¥ç›®å½•
        run: |
          mkdir -p dist/Binary dist/Docs
          cp -r opencore-repo/OpenCorePkg/Binary/* dist/Binary/
          cp -r opencore-repo/Docs/* dist/Docs/

      - name: ğŸš€ æäº¤åˆ°æ‚¨çš„ä»“åº“
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          repository: .  # åœ¨å½“å‰ç›®å½•æ“ä½œ
          commit_message: "ğŸ”„ åŒæ­¥ OpenCorePkg æœ€æ–°å†…å®¹"
          branch: main  # ç¡®ä¿ä¸æ‚¨çš„ä»“åº“é»˜è®¤åˆ†æ”¯ä¸€è‡´
          file_pattern: "dist/**"
          commit_options: '--allow-empty'
          push_options: '--force-with-lease'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… å®Œæˆé€šçŸ¥
        run: echo "ğŸ‰ OpenCorePkgåŒæ­¥å®Œæˆï¼æœ€æ–°æäº¤ï¼š$(git -C opencore-repo log -1 --pretty=format:%h)"
