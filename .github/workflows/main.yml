name: Sync BPB-Worker-Panel

on:
  schedule:
    - cron: "0 3 * * *"  # æ¯å¤©å‡Œæ™¨3ç‚¹æ‰§è¡Œ
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  id-token: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: ğŸ”„ æ£€å‡ºç›®æ ‡ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: bia-pain-bache/BPB-Worker-Panel
          path: target-repo
          fetch-depth: 0
          ref: main  # æ ¹æ®å®é™…åˆ†æ”¯ä¿®æ”¹ï¼ˆå¦‚ master/mainï¼‰
          lfs: true  # å¦‚æœä»“åº“ä½¿ç”¨ Git LFS

      - name: ğŸ” éªŒè¯ä»“åº“å†…å®¹
        run: |
          echo "å½“å‰ç›®å½•ç»“æ„ï¼š"
          ls -la target-repo/.git  # éªŒè¯.gitç›®å½•å­˜åœ¨
          git --git-dir=target-repo/.git status

      - name: ğŸ”„ åˆå§‹åŒ–å­æ¨¡å—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        working-directory: target-repo
        run: |
          git submodule update --init --recursive
          git submodule foreach 'git checkout $(git config -f $toplevel/.gitmodules submodule.$name.branch || echo main)'

      - name: ğŸ“ å‡†å¤‡åŒæ­¥ç›®å½•
        run: |
          mkdir -p dist
          cp -r target-repo/* dist/  # æ ¹æ®å®é™…ç›®å½•ç»“æ„è°ƒæ•´

      - name: ğŸš€ æäº¤åˆ°æ‚¨çš„ä»“åº“
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          repository: .  # åœ¨å½“å‰ç›®å½•æ“ä½œ
          commit_message: "ğŸ”„ åŒæ­¥ BPB-Worker-Panel æœ€æ–°å†…å®¹"
          branch: main  # ç¡®ä¿ä¸æ‚¨çš„ä»“åº“é»˜è®¤åˆ†æ”¯ä¸€è‡´
          file_pattern: "dist/**"
          commit_options: '--allow-empty'
          push_options: '--force-with-lease'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âœ… å®Œæˆé€šçŸ¥
        run: echo "ğŸ‰ BPB-Worker-Panel åŒæ­¥å®Œæˆï¼æœ€æ–°æäº¤ï¼š$(git -C target-repo log -1 --pretty=format:%h)"

      - name: âŒ é”™è¯¯å¤„ç†
        if: ${{ failure() }}
        run: |
          echo "âš ï¸ åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          exit 1
